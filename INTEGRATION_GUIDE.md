# XHS å¿ƒç†æµ‹è¯„ç³»ç»Ÿ - å‰åç«¯é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•å°† **xhs-evaluation-adminï¼ˆç®¡ç†åå°ï¼‰** ä¸ **xhs-evaluationï¼ˆç”¨æˆ·ç«¯ï¼‰** é›†æˆã€‚

---

## ğŸ¯ é›†æˆç›®æ ‡

è®©ç”¨æˆ·ç«¯ä»ã€Œç®€å•çš„ç¯å¢ƒå˜é‡éªŒè¯ã€å‡çº§åˆ°ã€Œå®Œæ•´çš„æ•°æ®åº“éªŒè¯ç ç³»ç»Ÿã€ï¼Œå®ç°ï¼š

- âœ… ç®¡ç†å‘˜åœ¨åå°åˆ›å»ºå’Œç®¡ç†éªŒè¯ç 
- âœ… ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥éªŒè¯ç è¿›è¡ŒéªŒè¯
- âœ… å®æ—¶è¿½è¸ªéªŒè¯ç ä½¿ç”¨æƒ…å†µ
- âœ… æ”¯æŒè¿‡æœŸæ—¶é—´å’Œä½¿ç”¨æ¬¡æ•°é™åˆ¶

---

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. Supabase é¡¹ç›®

ç¡®ä¿ä½ å·²ç»æœ‰ä¸€ä¸ª Supabase é¡¹ç›®ï¼Œè·å–ï¼š

- `SUPABASE_URL`: åœ¨ Settings > API > Project URL
- `SERVICE_ROLE_KEY`: åœ¨ Settings > API > Project API keys > service_role

### 2. å…‹éš†/ä¸‹è½½ä¸¤ä¸ªé¡¹ç›®

```bash
# ç”¨æˆ·ç«¯ï¼ˆå·²å­˜åœ¨ï¼‰
cd xhs-evaluation

# ç®¡ç†åå°ï¼ˆæ–°åˆ›å»ºï¼‰
cd xhs-evalution-admin
```

---

## ğŸš€ Step-by-Step é›†æˆæ­¥éª¤

### Step 1: åˆå§‹åŒ–ç®¡ç†åå°

```bash
cd xhs-evalution-admin
npm install
```

åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...your-key
ADMIN_SESSION_SECRET=your-random-secret-key
```

### Step 2: åˆå§‹åŒ–æ•°æ®åº“

åœ¨ Supabase Dashboard > SQL Editor æ‰§è¡Œï¼š

1. `supabaseSQL/verification_setup.sql` - åˆ›å»ºè¡¨å’Œç´¢å¼•
2. `supabaseSQL/insert_demo_code.sql` - æ’å…¥æµ‹è¯•éªŒè¯ç ï¼ˆå¯é€‰ï¼‰

éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

```sql
SELECT * FROM access_codes;
```

### Step 3: å¯åŠ¨ç®¡ç†åå°

```bash
cd xhs-evalution-admin
npm run dev
```

è®¿é—® [http://localhost:3000](http://localhost:3000)ï¼Œä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š

- é‚®ç®±: `admin@xhs-evaluation.com`
- å¯†ç : `Admin@2024!`

### Step 4: åˆ›å»ºæµ‹è¯•éªŒè¯ç 

åœ¨ç®¡ç†åå°ï¼š

1. è¿›å…¥ã€ŒéªŒè¯ç ç®¡ç†ã€é¡µé¢
2. ç‚¹å‡»ã€Œåˆ›å»ºéªŒè¯ç ã€
3. é€‰æ‹©ã€Œè‡ªå®šä¹‰ã€æ¨¡å¼
4. è¾“å…¥éªŒè¯ç : `TEST2024`
5. è®¾ç½®æœ‰æ•ˆæœŸ: 30å¤©å
6. è®¾ç½®æœ€å¤§ä½¿ç”¨æ¬¡æ•°: 100
7. ç‚¹å‡»ã€Œåˆ›å»ºã€

### Step 5: å‡çº§ç”¨æˆ·ç«¯éªŒè¯ API

ç¼–è¾‘ `xhs-evaluation/app/api/verify-code/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const VERIFICATION_WINDOW_MS = 72 * 60 * 60 * 1000; // 72å°æ—¶

/**
 * éªŒè¯ç éªŒè¯ APIï¼ˆå‡çº§ç‰ˆ - ä½¿ç”¨æ•°æ®åº“ï¼‰
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { code } = body;

    if (!code) {
      return NextResponse.json(
        { error: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º' },
        { status: 400 }
      );
    }

    // åˆ›å»º Supabase å®¢æˆ·ç«¯
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!,
      {
        auth: { persistSession: false }
      }
    );

    const trimmedCode = code.trim().toUpperCase();

    // 1. æŸ¥è¯¢éªŒè¯ç 
    const { data, error: queryError } = await supabase
      .from('access_codes')
      .select('id, expires_at, max_uses, used_count, plain_code')
      .eq('plain_code', trimmedCode)
      .single();

    if (queryError || !data) {
      return NextResponse.json(
        { error: 'éªŒè¯ç ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ' },
        { status: 401 }
      );
    }

    // 2. æ£€æŸ¥è¿‡æœŸæ—¶é—´
    const expiresAt = new Date(data.expires_at).getTime();
    if (expiresAt <= Date.now()) {
      return NextResponse.json(
        { error: 'éªŒè¯ç å·²è¿‡æœŸ' },
        { status: 401 }
      );
    }

    // 3. æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
    if (data.used_count >= data.max_uses) {
      return NextResponse.json(
        { error: 'éªŒè¯ç å·²è¾¾åˆ°ä½¿ç”¨ä¸Šé™' },
        { status: 401 }
      );
    }

    // 4. æ›´æ–°ä½¿ç”¨æ¬¡æ•°ï¼ˆä¹è§‚é”é˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰
    const { data: updatedRows, error: updateError } = await supabase
      .from('access_codes')
      .update({ used_count: data.used_count + 1 })
      .eq('id', data.id)
      .eq('used_count', data.used_count) // ä¹è§‚é”
      .select('id');

    if (updateError || !updatedRows || updatedRows.length === 0) {
      return NextResponse.json(
        { error: 'éªŒè¯ç å·²è¢«ä½¿ç”¨ï¼Œè¯·é‡è¯•' },
        { status: 409 }
      );
    }

    // 5. éªŒè¯æˆåŠŸï¼Œè¿”å›æœ‰æ•ˆæœŸæ—¶é—´æˆ³
    const verifiedUntil = Date.now() + VERIFICATION_WINDOW_MS;

    return NextResponse.json({
      verifiedUntil,
    });
  } catch (error) {
    console.error('Verification error:', error);
    return NextResponse.json(
      { error: 'æœåŠ¡å™¨é”™è¯¯' },
      { status: 500 }
    );
  }
}
```

### Step 6: å®‰è£… Supabase ä¾èµ–ï¼ˆç”¨æˆ·ç«¯ï¼‰

```bash
cd xhs-evaluation
npm install @supabase/supabase-js
```

### Step 7: æ›´æ–°ç”¨æˆ·ç«¯ç¯å¢ƒå˜é‡

ç¼–è¾‘ `xhs-evaluation/.env.local`:

```bash
# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3000/api

# Supabase Configuration (æ–°å¢)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...your-key

# Session Duration (ä¿æŒä¸å˜)
VERIFICATION_DURATION=259200000
```

âš ï¸ **åˆ é™¤æ—§çš„éªŒè¯ç ç¯å¢ƒå˜é‡**ï¼š
```bash
# VERIFICATION_CODE=test123  # åˆ é™¤è¿™è¡Œ
```

### Step 8: æµ‹è¯•é›†æˆ

#### 8.1 å¯åŠ¨ç”¨æˆ·ç«¯

```bash
cd xhs-evaluation
npm run dev
```

è®¿é—® [http://localhost:3001](http://localhost:3001)ï¼ˆæ³¨æ„ç«¯å£ä¸è¦å†²çªï¼‰

#### 8.2 æµ‹è¯•éªŒè¯æµç¨‹

1. è®¿é—®ä»»æ„æµ‹è¯•é¡µé¢ï¼ˆå¦‚ï¼šæ°´æœæ€§æ ¼æµ‹è¯•ï¼‰
2. å¼¹å‡ºéªŒè¯ç å¯¹è¯æ¡†
3. è¾“å…¥éªŒè¯ç : `TEST2024`
4. ç‚¹å‡»ã€Œç¡®è®¤éªŒè¯ã€
5. éªŒè¯æˆåŠŸï¼Œè¿›å…¥æµ‹è¯•é¡µé¢

#### 8.3 éªŒè¯åå°ç»Ÿè®¡

1. å›åˆ°ç®¡ç†åå° [http://localhost:3000/dashboard](http://localhost:3000/dashboard)
2. æŸ¥çœ‹ã€Œä»ªè¡¨ç›˜ã€
3. ç¡®è®¤ï¼š
   - ã€Œæ´»è·ƒéªŒè¯ç ã€æ•°é‡æ­£ç¡®
   - ã€Œä½¿ç”¨ç‡ã€å·²æ›´æ–°
   - ã€Œæœ€è¿‘è®°å½•ã€ä¸­çœ‹åˆ° `TEST2024` çš„ `used_count` ä» 0 å˜ä¸º 1

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: ç”¨æˆ·ç«¯æç¤ºã€ŒéªŒè¯ç ä¸å­˜åœ¨ã€

**åŸå› **: ç”¨æˆ·ç«¯å’Œç®¡ç†åå°è¿æ¥çš„ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®åº“

**è§£å†³**:
1. æ£€æŸ¥ä¸¤ç«¯ `.env.local` æ–‡ä»¶ä¸­çš„ `NEXT_PUBLIC_SUPABASE_URL` æ˜¯å¦ä¸€è‡´
2. æ£€æŸ¥ `SUPABASE_SERVICE_ROLE_KEY` æ˜¯å¦ä¸€è‡´
3. åœ¨ Supabase Dashboard ç¡®è®¤è¡¨ `access_codes` å­˜åœ¨

### é—®é¢˜2: éªŒè¯æˆåŠŸä½† `used_count` æ²¡æœ‰å¢åŠ 

**åŸå› **: ç”¨æˆ·ç«¯ä»£ç ä¸­çš„ä¹è§‚é”æ›´æ–°å¤±è´¥

**è§£å†³**:
1. æ£€æŸ¥ API ä»£ç ä¸­çš„ `eq('used_count', data.used_count)` æ˜¯å¦æ­£ç¡®
2. å°è¯•åˆ·æ–°åé‡æ–°éªŒè¯ï¼ˆå¯èƒ½æœ‰å¹¶å‘å†²çªï¼‰
3. æ£€æŸ¥ Supabase Dashboard çš„ Logs

### é—®é¢˜3: ç®¡ç†åå°åˆ›å»ºéªŒè¯ç å¤±è´¥

**åŸå› **: Service Role Key æƒé™ä¸è¶³æˆ–æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³**:
1. ç¡®è®¤ `SUPABASE_SERVICE_ROLE_KEY` æ˜¯ `service_role` è€Œä¸æ˜¯ `anon` key
2. æ£€æŸ¥ Supabase é¡¹ç›®æ˜¯å¦æš‚åœï¼ˆå…è´¹ç‰ˆ7å¤©ä¸æ´»åŠ¨ä¼šæš‚åœï¼‰
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

### é—®é¢˜4: å¤§å°å†™ä¸åŒ¹é…

**åŸå› **: ç”¨æˆ·è¾“å…¥ `test2024`ï¼Œä½†æ•°æ®åº“å­˜å‚¨çš„æ˜¯ `TEST2024`

**è§£å†³**: ç”¨æˆ·ç«¯ API å·²æ·»åŠ  `.toUpperCase()` è½¬æ¢ï¼Œç¡®ä¿ä»£ç ä¸­æœ‰ï¼š

```typescript
const trimmedCode = code.trim().toUpperCase();
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç®¡ç†å‘˜ç™»å½•åå°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºéªŒè¯ç  TEST2024  â”‚
â”‚  - æœ‰æ•ˆæœŸ: 30å¤©       â”‚
â”‚  - æœ€å¤§ä½¿ç”¨: 100æ¬¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase: access_codes è¡¨       â”‚
â”‚  plain_code: "TEST2024"         â”‚
â”‚  expires_at: 2025-01-01         â”‚
â”‚  max_uses: 100                  â”‚
â”‚  used_count: 0  â† åˆå§‹å€¼         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è®¿é—®æµ‹è¯•é¡µé¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼¹å‡ºéªŒè¯ç å¯¹è¯æ¡†      â”‚
â”‚  è¾“å…¥: TEST2024       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/verify-codeâ”‚
â”‚  { code: "TEST2024" } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase æŸ¥è¯¢éªŒè¯ç              â”‚
â”‚  1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨                 â”‚
â”‚  2. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ                 â”‚
â”‚  3. æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°                 â”‚
â”‚  4. used_count: 0 â†’ 1 â† é€’å¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› verifiedUntil   â”‚
â”‚  (72å°æ—¶æœ‰æ•ˆæœŸ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¿›å…¥æµ‹è¯•é¡µé¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
           â”‚ 72å°æ—¶å†…å…éªŒè¯
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  localStorage å­˜å‚¨    â”‚
â”‚  éªŒè¯çŠ¶æ€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ é›†æˆå®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ç®¡ç†åå°å¯ä»¥æ­£å¸¸å¯åŠ¨å’Œç™»å½•
- [ ] ç®¡ç†åå°å¯ä»¥åˆ›å»ºéªŒè¯ç 
- [ ] ç”¨æˆ·ç«¯å¯ä»¥è¾“å…¥éªŒè¯ç å¹¶éªŒè¯æˆåŠŸ
- [ ] ç®¡ç†åå°ä»ªè¡¨ç›˜æ˜¾ç¤ºæ­£ç¡®çš„ç»Ÿè®¡æ•°æ®
- [ ] éªŒè¯ç ä½¿ç”¨å `used_count` æ­£ç¡®é€’å¢
- [ ] éªŒè¯ç è¿‡æœŸåæ— æ³•ä½¿ç”¨
- [ ] éªŒè¯ç è¾¾åˆ°æœ€å¤§ä½¿ç”¨æ¬¡æ•°åæ— æ³•ä½¿ç”¨
- [ ] 72å°æ—¶å†…ç”¨æˆ·æ— éœ€é‡æ–°éªŒè¯

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **README.md** - è¯¦ç»†çš„é¡¹ç›®æ–‡æ¡£
2. **Supabase Dashboard** - æ•°æ®åº“è¡¨å’Œæ—¥å¿—
3. **æµè§ˆå™¨æ§åˆ¶å°** - æŸ¥çœ‹å‰ç«¯é”™è¯¯
4. **Next.js ç»ˆç«¯** - æŸ¥çœ‹åç«¯æ—¥å¿—

---

**ç¥ä½ é›†æˆé¡ºåˆ©ï¼** ğŸš€
